var tilemap,x$;tilemap={},tilemap.cartogram={container:null,store:{projection:d3.geo.mercator(),value:function(){return Math.round(100*Math.random())},topojson:null,object:null},init:function(t,n,e){var r;return r=this.store,r.topojson=n,r.object=e,this.container=t.append("g")},projection:function(t){return this.store.projection=t},value:function(t){return this.store.value=t},features:function(){var t=this;return this.carto=d3.cartogram().projection(this.store.projection).value(this.store.value),this.store.features=this.carto(this.store.topojson,this.store.object).features,this.store.features.map(function(n,e){return n.properties=t.store.object[e].properties}),this.store.features},render:function(){var t,n=this;return t=this.container.selectAll("path").data(this.store.features),t.exit().remove(),t.enter().append("path"),this.container.selectAll("path").attr({d:this.carto.path}),this.store.features.forEach(function(t){return t.properties.area=n.carto.path.area(t)}),this.store.area=this.store.features.reduce(function(t,n){return n.properties.area+t},0)},pin:function(t,n){var e;return e=document.elementFromPoint(t,n),e&&d3.select(e).datum()?{node:e,data:d3.select(e).datum()}:null}},tilemap.hexagon={map:[],list:[],container:null,init:function(t,n,e){var r,a,i,o,s,u,c,h,p,l,d=[];for(null==e&&(e=1),this.container=t.append("g"),this.cartogram=n,this.step=e,r=[[],[]],this.map=r[0],this.list=r[1],a=n.container[0][0].getBoundingClientRect(),r=[Math.round(a.width/(2*e))+1,Math.round(a.height/(.8660254037844386*e))+1],i=r[0],o=r[1],this.map=d3.range(o).map(function(){return d3.range(i).map(function(){return null})}),this.list=[],s=0;i>s;++s){for(u=s,c=[],h=0;o>h;++h)p=h,l={idx:{x:u,y:p},x:(u+p%2/2)*e*3+a.left,y:p*e*.8660254037844386+a.top,r:e},this.map[p][u]=l,c.push(this.list.push(l));d.push(c)}return d},bind:function(){function t(t,n){return n.count-t.count}var n,e,r,a,i,o,s,u,c,h,p,l,d,f,m;for(this.container.selectAll("path").attr({display:"none"}),this.container.selectAll("line").attr({display:"none"}),n=0,r=(e=this.list).length;r>n;++n){for(a=e[n],a.pin=null,i={},o=0;5>o;++o)s=o,u=Math.random()*Math.PI*2,c=this.step*Math.random(),h=this.cartogram.pin(a.x+c*Math.cos(u),a.y+c*Math.sin(u)),h&&(p=h.data.properties.C_Name,i[p]||(i[p]={pin:h,count:0}),i[p].count++);d=[];for(f in i)m=i[f],d.push(m);l=d,l.sort(t),l[0]&&(a.pin=l[0].pin)}return this.boundary()},path:function(t,n,e){var r,a;return r=function(){var t,n=[];for(t=0;360>=t;t+=60)a=t,n.push(a);return n}().map(function(t){return(t+90)*Math.PI/180}).map(function(r){return{x:Math.sin(r)*e+t,y:Math.cos(r)*e+n}}).map(function(t){return t.x+","+t.y}).join("L"),"M"+r+"Z"},render:function(){var t,n,e=this;return t=this.container.selectAll("path").data(this.list),t.exit().remove(),t.enter().append("path"),this.container.selectAll("path").attr({display:"block",d:function(t){return e.path(t.x,t.y,t.r)}}).each(function(t){return t.node=this}),n=this.container.selectAll("line").data(this.boundaries),n.exit().remove(),n.enter().append("line"),this.container.selectAll("line").attr({x1:function(t){return t.x1},x2:function(t){return t.x2},y1:function(t){return t.y1},y2:function(t){return t.y2},stroke:"#000","stroke-width":2,display:"block"})},boundary:function(){var t=this;return this.boundaries=[],this.list.map(function(n){var e,r,a,i,o,s,u,c,h,p,l,d,f,m,y,x,g,v=[];for(e=[n.idx,-1],r=e[0],a=e[1],i=r.y%2?1:0,o=!1,s=0,u=(e=[[0,-2],[i,-1],[i,1],[0,2],[i-1,1],[i-1,-1]]).length;u>s;++s)c=e[s],a++,h=[r.x+c[0],r.y+c[1]],p=h[0],l=h[1],d=n.pin,f=t.map[l]&&t.map[l][p]?t.map[l][p].pin:null,(d||{}).data!==(f||{}).data&&(m=n.x+t.step*Math.sin(2*Math.PI*(a-.5)/6),y=n.x+t.step*Math.sin(2*Math.PI*(a+.5)/6),x=n.y-t.step*Math.cos(2*Math.PI*(a-.5)/6),g=n.y-t.step*Math.cos(2*Math.PI*(a+.5)/6),v.push(t.boundaries.push({idx:r,angle:a,x1:m,x2:y,y1:x,y2:g})));return v})},flip:function(t,n,e){var r,a,i,o,s,u,c,h,p,l,d,f,m,y;if(this.map[n]&&this.map[n][t]){for(r=this.map[n][t],a=r.idx,i=a.y%2?1:-1,o={},s=0,c=(u=[[-1,0],[1,0],[0,-1],[i,-1],[0,1],[i,1]]).length;c>s;++s)h=u[s],p=[a.x+h[0],a.y+h[1]],l=p[0],d=p[1],this.map[d]&&this.map[d][l]&&this.map[d][l].pin?o[this.map[d][l].pin.data.properties.C_Name]=this.map[d][l].pin:o[""]=null;m=[];for(y in o)m.push(y);return f=m,f.sort(),a=f.indexOf(r.pin?r.pin.data.properties.C_Name:""),r.pin=null!=e?e:o[f[(a+1)%f.length]],this.boundary()}}},x$=angular.module("main",[]),x$.controller("main",["$scope","$timeout"].concat(function(t,n){return t.counties=[],d3.json("twCounty2015.topo.json",function(e){var r,a,i,o,s,u,c,h,p,l,d;return r=d3.select("#svg"),a=d3.scale.category20(),i=r[0][0].getBoundingClientRect(),o=d3.geo.mercator().center([121,23.6]).scale(7e3).translate([i.width/2,i.height/2]),s=function(t){return t[1]>25.5&&(t[1]-=1),t[0]<119&&(t[0]+=1.2),o(t)},u=[tilemap.cartogram,tilemap.hexagon],c=u[0],h=u[1],p=c,p.init(r,e,e.objects.County_MOI_1041215.geometries),p.projection(s),p.features(),p.render(),t.$apply(function(){return t.counties=c.store.features.map(function(t){return{name:t.properties.C_Name,value:Math.round(100*Math.random())}})}),c.container.selectAll("path").attr({opacity:.1,stroke:"#fff","stroke-width":0}),l=h,l.init(r,c,12),l.bind(),l.render(),d=function(){return h.container.selectAll("line").attr({opacity:.9}),h.container.selectAll("path").attr({fill:function(t){return t.pin?a(t.pin.data.properties.C_Name):"#fff"},stroke:"#fff",opacity:.9})},d(),t.handler=null,t.handle=function(){var n;return n=c,n.value(function(n,e){var r,a;return r=c.store.object[e].properties,a=t.counties.filter(function(t){return t.name===r.C_Name})[0],a?a.value||.1:1}),n.features(),n.render(),h.bind(),h.render(),d()},t.$watch("counties",function(){return t.handler&&n.cancel(t.handler),t.handler=n(function(){return t.handle(),t.handler=null},100)},!0)})}));