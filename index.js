var tilemap,x$;tilemap={},tilemap.cartogram={container:null,store:{projection:d3.geo.mercator(),value:function(){return Math.round(100*Math.random())},topojson:null,object:null},init:function(t,n,e){var r;return r=this.store,r.topojson=n,r.object=e,this.container=t.append("g")},projection:function(t){return this.store.projection=t},value:function(t){return this.store.value=t},features:function(){var t=this;return this.carto=d3.cartogram().projection(this.store.projection).value(this.store.value),this.store.features=this.carto(this.store.topojson,this.store.object).features,this.store.features.map(function(n,e){return n.properties=t.store.object[e].properties}),this.store.features},render:function(){var t,n=this;return t=this.container.selectAll("path").data(this.store.features),t.exit().remove(),t.enter().append("path"),this.container.selectAll("path").attr({d:this.carto.path}),this.store.features.forEach(function(t){return t.properties.area=n.carto.path.area(t)}),this.store.area=this.store.features.reduce(function(t,n){return n.properties.area+t},0)},pin:function(t,n){var e;return e=document.elementFromPoint(t,n),e&&d3.select(e).datum()?{node:e,data:d3.select(e).datum()}:null}},tilemap.hexagon={map:[],list:[],container:null,init:function(t,n,e){var r,i,a,o,s,u,c,h,l,p,d=[];for(null==e&&(e=1),this.container=t.append("g"),this.cartogram=n,this.step=e,r=[[],[]],this.map=r[0],this.list=r[1],i=n.container[0][0].getBoundingClientRect(),r=[Math.round(i.width/(2*e))+1,Math.round(i.height/(.8660254037844386*e))+1],a=r[0],o=r[1],this.map=d3.range(o).map(function(){return d3.range(a).map(function(){return null})}),this.list=[],s=0;a>s;++s){for(u=s,c=[],h=0;o>h;++h)l=h,p={idx:{x:u,y:l},x:(u+l%2/2)*e*3+i.left,y:l*e*.8660254037844386+i.top,r:e},this.map[l][u]=p,c.push(this.list.push(p));d.push(c)}return d},bind:function(){function t(t,n){return n.count-t.count}var n,e,r,i,a,o,s,u,c,h,l,p,d,f,m;for(this.container.selectAll("path").attr({display:"none"}),this.container.selectAll("line").attr({display:"none"}),n=0,r=(e=this.list).length;r>n;++n){for(i=e[n],i.pin=null,a={},o=0;5>o;++o)s=o,u=Math.random()*Math.PI*2,c=this.step*Math.random(),h=this.cartogram.pin(i.x+c*Math.cos(u),i.y+c*Math.sin(u)),h&&(l=h.data.properties.C_Name,a[l]||(a[l]={pin:h,count:0}),a[l].count++);d=[];for(f in a)m=a[f],d.push(m);p=d,p.sort(t),p[0]&&(i.pin=p[0].pin)}return this.boundary()},path:function(t,n,e){var r,i;return r=function(){var t,n=[];for(t=0;360>=t;t+=60)i=t,n.push(i);return n}().map(function(t){return(t+90)*Math.PI/180}).map(function(r){return{x:Math.sin(r)*e+t,y:Math.cos(r)*e+n}}).map(function(t){return t.x+","+t.y}).join("L"),"M"+r+"Z"},render:function(){var t,n,e=this;return t=this.container.selectAll("path").data(this.list),t.exit().remove(),t.enter().append("path"),this.container.selectAll("path").attr({display:"block",d:function(t){return e.path(t.x,t.y,t.r)}}).each(function(t){return t.node=this}),n=this.container.selectAll("line").data(this.boundaries),n.exit().remove(),n.enter().append("line"),this.container.selectAll("line").attr({x1:function(t){return t.x1},x2:function(t){return t.x2},y1:function(t){return t.y1},y2:function(t){return t.y2},stroke:"#000","stroke-width":2,display:"block"})},boundary:function(){var t=this;return this.boundaries=[],this.list.map(function(n){var e,r,i,a,o,s,u,c,h,l,p,d,f,m,g,y,x,v=[];for(e=[n.idx,-1],r=e[0],i=e[1],a=r.y%2?1:0,o=!1,s=0,u=(e=[[0,-2],[a,-1],[a,1],[0,2],[a-1,1],[a-1,-1]]).length;u>s;++s)c=e[s],i++,h=[r.x+c[0],r.y+c[1]],l=h[0],p=h[1],d=n.pin,f=t.map[p]&&t.map[p][l]?t.map[p][l].pin:null,(d||{}).data!==(f||{}).data&&(m=n.x+t.step*Math.sin(2*Math.PI*(i-.5)/6),g=n.x+t.step*Math.sin(2*Math.PI*(i+.5)/6),y=n.y-t.step*Math.cos(2*Math.PI*(i-.5)/6),x=n.y-t.step*Math.cos(2*Math.PI*(i+.5)/6),v.push(t.boundaries.push({idx:r,angle:i,x1:m,x2:g,y1:y,y2:x})));return v})},flip:function(t,n,e){var r,i,a,o,s,u,c,h,l,p,d,f,m,g;if(this.map[n]&&this.map[n][t]){for(r=this.map[n][t],i=r.idx,a=i.y%2?1:-1,o={},s=0,c=(u=[[-1,0],[1,0],[0,-1],[a,-1],[0,1],[a,1]]).length;c>s;++s)h=u[s],l=[i.x+h[0],i.y+h[1]],p=l[0],d=l[1],this.map[d]&&this.map[d][p]&&this.map[d][p].pin?o[this.map[d][p].pin.data.properties.C_Name]=this.map[d][p].pin:o[""]=null;m=[];for(g in o)m.push(g);return f=m,f.sort(),i=f.indexOf(r.pin?r.pin.data.properties.C_Name:""),r.pin=null!=e?e:o[f[(i+1)%f.length]],this.boundary()}}},x$=angular.module("main",[]),x$.controller("main",["$scope","$timeout"].concat(function(t,n){return t.counties=[],document.body.getBoundingClientRect().width>640&&(t.showConfig=!0),d3.json("twCounty2015.topo.json",function(e){var r,i,a,o,s,u,c,h,l,p,d,f,m,g;return r=d3.select("#svg"),i=d3.scale.category20(),a=r[0][0].getBoundingClientRect(),o=[17*a.width,13*a.height],s=o[0],u=o[1],c=s>u?u:s,h=d3.geo.mercator().center([121,23.6]).scale(c).translate([a.width/2,a.height/2]),l=function(t){return t[1]>25.5&&(t[1]-=1),t[0]<119&&(t[0]+=1.2),h(t)},o=[tilemap.cartogram,tilemap.hexagon],p=o[0],d=o[1],f=p,f.init(r,e,e.objects.County_MOI_1041215.geometries),f.projection(l),f.features(),f.render(),t.$apply(function(){return t.counties=p.store.features.map(function(t){return{name:t.properties.C_Name,value:Math.round(100*Math.random())}})}),p.container.selectAll("path").attr({opacity:.1,stroke:"#fff","stroke-width":0}),m=d,m.init(r,p,12),m.bind(),m.render(),g=function(){return d.container.selectAll("line").attr({opacity:.9}),d.container.selectAll("path").attr({fill:function(t){return t.pin?i(t.pin.data.properties.C_Name):"#fff"},stroke:"#fff",opacity:.9})},g(),t.handler=null,t.handle=function(){var n;return n=p,n.value(function(n,e){var r,i;return r=p.store.object[e].properties,i=t.counties.filter(function(t){return t.name===r.C_Name})[0],i?i.value||.1:1}),n.features(),n.render(),d.bind(),d.render(),g()},t.$watch("counties",function(){return t.handler&&n.cancel(t.handler),t.handler=n(function(){return t.handle(),t.handler=null},100)},!0),t.$watch("showConfig",function(){return n(function(){return t.handle()},10)})})}));